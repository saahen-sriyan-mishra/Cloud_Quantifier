name: CI/CD Pipeline

on:
  push:
    branches: [ development ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ← ADD THIS: Get full git history

      - name: Setup Docker
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Build and Test
        run: |
          echo "🏗️ Building Docker images..."
          docker-compose build
          
          echo "🧪 Running test suite..."
          # Use exit-code-from to properly fail the step
          docker-compose up --build --exit-code-from test test
          
          echo "✅ All tests passed!"

   auto-merge:
    needs: test
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Create Pull Request
        uses: repo-sync/pull-request@v2
        with:
          destination_branch: "master"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_title: "Auto-merge: CI Tests Passed"
          pr_body: "Automatically merged after all CI tests passed"
          pr_reviewer: "saahen-sriyan-mishra"